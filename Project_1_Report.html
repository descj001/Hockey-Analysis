<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.24">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Hockey Analytics: Predicting Goals and Finding the NHL’s Best Shooters</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="Project_1_Report_files/libs/clipboard/clipboard.min.js"></script>
<script src="Project_1_Report_files/libs/quarto-html/quarto.js" type="module"></script>
<script src="Project_1_Report_files/libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="Project_1_Report_files/libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="Project_1_Report_files/libs/quarto-html/popper.min.js"></script>
<script src="Project_1_Report_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="Project_1_Report_files/libs/quarto-html/anchor.min.js"></script>
<link href="Project_1_Report_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="Project_1_Report_files/libs/quarto-html/quarto-syntax-highlighting-dc55a5b9e770e841cd82e46aadbfb9b0.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="Project_1_Report_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="Project_1_Report_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="Project_1_Report_files/libs/bootstrap/bootstrap-d6a003b94517c951b2d65075d42fb01b.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN" && texText && texText.data) {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="styles.css">
</head>

<body class="quarto-light">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#motivation" id="toc-motivation" class="nav-link active" data-scroll-target="#motivation">Motivation</a></li>
  <li><a href="#data-preparation" id="toc-data-preparation" class="nav-link" data-scroll-target="#data-preparation">Data Preparation</a></li>
  <li><a href="#model-1" id="toc-model-1" class="nav-link" data-scroll-target="#model-1">Model 1</a></li>
  <li><a href="#model-2" id="toc-model-2" class="nav-link" data-scroll-target="#model-2">Model 2</a></li>
  <li><a href="#model-3" id="toc-model-3" class="nav-link" data-scroll-target="#model-3">Model 3</a></li>
  <li><a href="#model-comparison" id="toc-model-comparison" class="nav-link" data-scroll-target="#model-comparison">Model Comparison</a></li>
  <li><a href="#findings" id="toc-findings" class="nav-link" data-scroll-target="#findings">Findings</a></li>
  <li><a href="#improvements" id="toc-improvements" class="nav-link" data-scroll-target="#improvements">Improvements</a></li>
  <li><a href="#next-steps" id="toc-next-steps" class="nav-link" data-scroll-target="#next-steps">Next Steps</a></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Hockey Analytics: Predicting Goals and Finding the NHL’s Best Shooters</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(hockeyR)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<section id="motivation" class="level2">
<h2 class="anchored" data-anchor-id="motivation">Motivation</h2>
<p>We decided to analyze play-by-play NHL data to answer the question of who the best goal scorers are in the league. We want to know who is scoring goals in situations that other players would most likely not, or who is missing goals when others would most likely score. We will do this by building 3 different models that predict expected goals scored on a play. We will test these models against each other to find which most accurately predicts the expected goals a player has on a play. We will then find the players from the 2023-2024 season who had the most goals over expected in our models, to best answer the question of who were the most skilled goal scorers in that season.</p>
</section>
<section id="data-preparation" class="level2">
<h2 class="anchored" data-anchor-id="data-preparation">Data Preparation</h2>
<p>We will be using <a href="https://hockeyr.netlify.app/">HockeyR’s</a> play-by-play data to answer these questions. We will use the 2020-2023 seasons to train our models and the 2023-2024 season to test them. Here we will load in all the play by play data for all the seasons</p>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Important</span>Warning
</div>
</div>
<div class="callout-body-container callout-body">
<p>This chunk will take a longer download time.</p>
</div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>pbp20 <span class="ot">=</span> <span class="fu">load_pbp</span>(<span class="st">'2020-21'</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>pbp21 <span class="ot">=</span> <span class="fu">load_pbp</span>(<span class="st">'2021-22'</span>)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>pbp22 <span class="ot">=</span> <span class="fu">load_pbp</span>(<span class="st">'2022-23'</span>)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>pbp23 <span class="ot">=</span> <span class="fu">load_pbp</span>(<span class="st">'2023-24'</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>We will then modify our 2023-2024 season data to match the previous seasons. The most recent seasons have a different column name for secondary_type, as well as different formatting for the values in that column. We change these to be consistent across all our data. We will also split into train and test sets.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="annotated-cell-3"><pre class="sourceCode r code-annotation-code code-with-copy code-annotated"><code class="sourceCode r"><a class="code-annotation-anchor" data-target-cell="annotated-cell-3" data-target-annotation="1" onclick="event.preventDefault();" href="">1</a><span id="annotated-cell-3-1" class="code-annotation-target"><a href="#annotated-cell-3-1" aria-hidden="true" tabindex="-1"></a>pbp_train <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(pbp20, pbp21, pbp22)</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-3" data-target-annotation="2" onclick="event.preventDefault();" href="">2</a><span id="annotated-cell-3-2" class="code-annotation-target"><a href="#annotated-cell-3-2" aria-hidden="true" tabindex="-1"></a>pbp_test <span class="ot">&lt;-</span> pbp23</span>
<span id="annotated-cell-3-3"><a href="#annotated-cell-3-3" aria-hidden="true" tabindex="-1"></a>pbp_test <span class="ot">&lt;-</span> pbp_test <span class="sc">%&gt;%</span></span>
<span id="annotated-cell-3-4"><a href="#annotated-cell-3-4" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>secondary_type) <span class="sc">%&gt;%</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-3" data-target-annotation="3" onclick="event.preventDefault();" href="">3</a><span id="annotated-cell-3-5" class="code-annotation-target"><a href="#annotated-cell-3-5" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">secondary_type =</span> shotType)</span>
<span id="annotated-cell-3-6"><a href="#annotated-cell-3-6" aria-hidden="true" tabindex="-1"></a>pbp_test <span class="ot">&lt;-</span> pbp_test <span class="sc">|&gt;</span> </span>
<span id="annotated-cell-3-7"><a href="#annotated-cell-3-7" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-3" data-target-annotation="4" onclick="event.preventDefault();" href="">4</a><span id="annotated-cell-3-8" class="code-annotation-target"><a href="#annotated-cell-3-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">secondary_type =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="annotated-cell-3-9"><a href="#annotated-cell-3-9" aria-hidden="true" tabindex="-1"></a>      secondary_type <span class="sc">==</span> <span class="st">"wrist"</span> <span class="sc">~</span> <span class="st">"Wrist Shot"</span>,</span>
<span id="annotated-cell-3-10"><a href="#annotated-cell-3-10" aria-hidden="true" tabindex="-1"></a>      secondary_type <span class="sc">==</span> <span class="st">"backhand"</span> <span class="sc">~</span> <span class="st">"Backhand"</span>,</span>
<span id="annotated-cell-3-11"><a href="#annotated-cell-3-11" aria-hidden="true" tabindex="-1"></a>      secondary_type <span class="sc">==</span> <span class="st">"snap"</span> <span class="sc">~</span> <span class="st">"Snap Shot"</span>,</span>
<span id="annotated-cell-3-12"><a href="#annotated-cell-3-12" aria-hidden="true" tabindex="-1"></a>      secondary_type <span class="sc">==</span> <span class="st">"slap"</span> <span class="sc">~</span> <span class="st">"Slap Shot"</span>,</span>
<span id="annotated-cell-3-13"><a href="#annotated-cell-3-13" aria-hidden="true" tabindex="-1"></a>      secondary_type <span class="sc">==</span> <span class="st">"tip-in"</span> <span class="sc">~</span> <span class="st">"Tip-In"</span>,</span>
<span id="annotated-cell-3-14"><a href="#annotated-cell-3-14" aria-hidden="true" tabindex="-1"></a>      secondary_type <span class="sc">==</span> <span class="st">"wrap-around"</span> <span class="sc">~</span> <span class="st">"Wrap-around"</span>,</span>
<span id="annotated-cell-3-15"><a href="#annotated-cell-3-15" aria-hidden="true" tabindex="-1"></a>      secondary_type <span class="sc">==</span> <span class="st">"deflected"</span> <span class="sc">~</span> <span class="st">"Deflected"</span>,</span>
<span id="annotated-cell-3-16"><a href="#annotated-cell-3-16" aria-hidden="true" tabindex="-1"></a>      secondary_type <span class="sc">==</span> <span class="st">"poke"</span> <span class="sc">~</span> <span class="st">"Poke"</span>,</span>
<span id="annotated-cell-3-17"><a href="#annotated-cell-3-17" aria-hidden="true" tabindex="-1"></a>      secondary_type <span class="sc">==</span> <span class="st">"bat"</span> <span class="sc">~</span> <span class="st">"Batted"</span>,</span>
<span id="annotated-cell-3-18"><a href="#annotated-cell-3-18" aria-hidden="true" tabindex="-1"></a>      secondary_type <span class="sc">==</span> <span class="st">"between-legs"</span> <span class="sc">~</span> <span class="st">"Between Legs"</span>,</span>
<span id="annotated-cell-3-19"><a href="#annotated-cell-3-19" aria-hidden="true" tabindex="-1"></a>      secondary_type <span class="sc">==</span> <span class="st">"cradle"</span> <span class="sc">~</span> <span class="st">"Cradle"</span>,</span>
<span id="annotated-cell-3-20"><a href="#annotated-cell-3-20" aria-hidden="true" tabindex="-1"></a>      <span class="cn">TRUE</span> <span class="sc">~</span> secondary_type</span>
<span id="annotated-cell-3-21"><a href="#annotated-cell-3-21" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="annotated-cell-3-22"><a href="#annotated-cell-3-22" aria-hidden="true" tabindex="-1"></a>  )</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-annotation">
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-3" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-3" data-code-lines="1" data-code-annotation="1">Combine 2020-2023 seasons into the training set.</span>
</dd>
<dt data-target-cell="annotated-cell-3" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-3" data-code-lines="2" data-code-annotation="2">Use the 2023-24 season as testing set</span>
</dd>
<dt data-target-cell="annotated-cell-3" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-3" data-code-lines="5" data-code-annotation="3">Drop the old secondary_type column and rename shotType to secondary_type</span>
</dd>
<dt data-target-cell="annotated-cell-3" data-target-annotation="4">4</dt>
<dd>
<span data-code-cell="annotated-cell-3" data-code-lines="8" data-code-annotation="4">Standardize shot type labels</span>
</dd>
</dl>
</div>
</div>
</section>
<section id="model-1" class="level2">
<h2 class="anchored" data-anchor-id="model-1">Model 1</h2>
<p>We will prepare our training data for our first model. Our first model will find the average of goals scored for each shot type a player can take. We start by filtering by plays that were either shots or goals and adding a numerical column to “Y” to represent goals. We also keep a column of hockeyR’s expected goals for each play that we will use to compare against our models. Here is a look at our data.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="annotated-cell-4"><pre class="sourceCode r code-annotation-code code-with-copy code-annotated"><code class="sourceCode r"><span id="annotated-cell-4-1"><a href="#annotated-cell-4-1" aria-hidden="true" tabindex="-1"></a>pbp_model_1 <span class="ot">&lt;-</span> pbp_train <span class="sc">|&gt;</span> </span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-4" data-target-annotation="1" onclick="event.preventDefault();" href="">1</a><span id="annotated-cell-4-2" class="code-annotation-target"><a href="#annotated-cell-4-2" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(event_type <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"SHOT"</span>, <span class="st">"GOAL"</span>)) <span class="sc">|&gt;</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-4" data-target-annotation="2" onclick="event.preventDefault();" href="">2</a><span id="annotated-cell-4-3" class="code-annotation-target"><a href="#annotated-cell-4-3" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(event_type,secondary_type,event_player_1_name, xg) <span class="sc">|&gt;</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-4" data-target-annotation="3" onclick="event.preventDefault();" href="">3</a><span id="annotated-cell-4-4" class="code-annotation-target"><a href="#annotated-cell-4-4" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">Y =</span> <span class="fu">ifelse</span>(event_type <span class="sc">==</span> <span class="st">"GOAL"</span>,<span class="dv">1</span>,<span class="dv">0</span>))</span>
<span id="annotated-cell-4-5"><a href="#annotated-cell-4-5" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(pbp_model_1)</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-annotation">
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-4" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-4" data-code-lines="2" data-code-annotation="1">Filtering plays to shots/goals only</span>
</dd>
<dt data-target-cell="annotated-cell-4" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-4" data-code-lines="3" data-code-annotation="2">Select relevant columns</span>
</dd>
<dt data-target-cell="annotated-cell-4" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-4" data-code-lines="4" data-code-annotation="3">Add numeric goal column</span>
</dd>
</dl>
</div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 5
  event_type secondary_type event_player_1_name     xg     Y
  &lt;chr&gt;      &lt;chr&gt;          &lt;chr&gt;                &lt;dbl&gt; &lt;dbl&gt;
1 SHOT       Wrist Shot     Travis.Konecny      0.0204     0
2 SHOT       Wrist Shot     Evan.Rodrigues      0.0208     0
3 SHOT       Backhand       Joel.Farabee        0.0148     0
4 SHOT       Snap Shot      Evan.Rodrigues      0.0131     0
5 SHOT       Slap Shot      Claude.Giroux       0.171      0
6 SHOT       Wrist Shot     Philippe.Myers      0.281      0</code></pre>
</div>
</div>
<p>Next we will create a table that contains the shooting percentage for each shot type from our testing data. Our model will calculate shooting percentage as shown.</p>
<p><span class="math display">\[
\text{Shooting\%}_{\text{shot\_type}}
= \frac{\sum \text{goals}_{\text{shot\_type}}}
       {\sum \left(\text{shots}_{\text{shot\_type}}\right)}
\]</span></p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="annotated-cell-5"><pre class="sourceCode r code-annotation-code code-with-copy code-annotated"><code class="sourceCode r"><span id="annotated-cell-5-1"><a href="#annotated-cell-5-1" aria-hidden="true" tabindex="-1"></a>shots_model_1 <span class="ot">&lt;-</span> pbp_model_1 <span class="sc">|&gt;</span> </span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-5" data-target-annotation="1" onclick="event.preventDefault();" href="">1</a><span id="annotated-cell-5-2" class="code-annotation-target"><a href="#annotated-cell-5-2" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">group_by</span>(secondary_type) <span class="sc">|&gt;</span></span>
<span id="annotated-cell-5-3"><a href="#annotated-cell-5-3" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">summarize</span>(</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-5" data-target-annotation="2" onclick="event.preventDefault();" href="">2</a><span id="annotated-cell-5-4" class="code-annotation-target"><a href="#annotated-cell-5-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">shots =</span> <span class="fu">n</span>(),</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-5" data-target-annotation="3" onclick="event.preventDefault();" href="">3</a><span id="annotated-cell-5-5" class="code-annotation-target"><a href="#annotated-cell-5-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">goals =</span> <span class="fu">sum</span>(Y),</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-5" data-target-annotation="4" onclick="event.preventDefault();" href="">4</a><span id="annotated-cell-5-6" class="code-annotation-target"><a href="#annotated-cell-5-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">shooting_pct =</span> <span class="fu">mean</span>(Y),</span>
<span id="annotated-cell-5-7"><a href="#annotated-cell-5-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-5" data-target-annotation="5" onclick="event.preventDefault();" href="">5</a><span id="annotated-cell-5-8" class="code-annotation-target"><a href="#annotated-cell-5-8" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> <span class="fu">drop_na</span>(secondary_type)</span>
<span id="annotated-cell-5-9"><a href="#annotated-cell-5-9" aria-hidden="true" tabindex="-1"></a>shots_model_1</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-annotation">
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-5" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-5" data-code-lines="2" data-code-annotation="1">Group by shot type</span>
</dd>
<dt data-target-cell="annotated-cell-5" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-5" data-code-lines="4" data-code-annotation="2">Count total shots</span>
</dd>
<dt data-target-cell="annotated-cell-5" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-5" data-code-lines="5" data-code-annotation="3">Count total goals</span>
</dd>
<dt data-target-cell="annotated-cell-5" data-target-annotation="4">4</dt>
<dd>
<span data-code-cell="annotated-cell-5" data-code-lines="6" data-code-annotation="4">Calculate shooting percentage</span>
</dd>
<dt data-target-cell="annotated-cell-5" data-target-annotation="5">5</dt>
<dd>
<span data-code-cell="annotated-cell-5" data-code-lines="8" data-code-annotation="5">Remove rows with NA shot types</span>
</dd>
</dl>
</div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 12 × 4
   secondary_type  shots goals shooting_pct
   &lt;chr&gt;           &lt;int&gt; &lt;dbl&gt;        &lt;dbl&gt;
 1 Backhand        18506  2192       0.118 
 2 Batted            202    51       0.252 
 3 Between Legs       52     8       0.154 
 4 Cradle              3     1       0.333 
 5 Deflected        4281   698       0.163 
 6 Penalty Shot       93    34       0.366 
 7 Poke              415    64       0.154 
 8 Slap Shot       29378  2132       0.0726
 9 Snap Shot       33737  3849       0.114 
10 Tip-In          13203  2203       0.167 
11 Wrap-around      2108   143       0.0678
12 Wrist Shot     132275 12084       0.0914</code></pre>
</div>
</div>
<p>As we can see, penalty shots go in at a much higher rate than most other shots, which makes sense intuitively. Now we can add shooting_pct to our test data, and find what players in the 2023-2024 season have the most goals over expected using this model.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="annotated-cell-6"><pre class="sourceCode r code-annotation-code code-with-copy code-annotated"><code class="sourceCode r"><span id="annotated-cell-6-1"><a href="#annotated-cell-6-1" aria-hidden="true" tabindex="-1"></a>model_1_test <span class="ot">&lt;-</span> pbp_test <span class="sc">|&gt;</span> </span>
<span id="annotated-cell-6-2"><a href="#annotated-cell-6-2" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(event_type <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"SHOT"</span>, <span class="st">"GOAL"</span>)) <span class="sc">|&gt;</span> </span>
<span id="annotated-cell-6-3"><a href="#annotated-cell-6-3" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(event_type, secondary_type, event_player_1_name) <span class="sc">|&gt;</span> </span>
<span id="annotated-cell-6-4"><a href="#annotated-cell-6-4" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">Y =</span> <span class="fu">ifelse</span>(event_type <span class="sc">==</span> <span class="st">"GOAL"</span>, <span class="dv">1</span>, <span class="dv">0</span>)) <span class="sc">|&gt;</span> </span>
<span id="annotated-cell-6-5"><a href="#annotated-cell-6-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(shots_model_1, <span class="at">by =</span> <span class="st">"secondary_type"</span>)</span>
<span id="annotated-cell-6-6"><a href="#annotated-cell-6-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-6-7"><a href="#annotated-cell-6-7" aria-hidden="true" tabindex="-1"></a>goe_model_1 <span class="ot">&lt;-</span> </span>
<span id="annotated-cell-6-8"><a href="#annotated-cell-6-8" aria-hidden="true" tabindex="-1"></a>  model_1_test <span class="sc">|&gt;</span> </span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-6" data-target-annotation="1" onclick="event.preventDefault();" href="">1</a><span id="annotated-cell-6-9" class="code-annotation-target"><a href="#annotated-cell-6-9" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">diff =</span> Y <span class="sc">-</span> shooting_pct) <span class="sc">|&gt;</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-6" data-target-annotation="2" onclick="event.preventDefault();" href="">2</a><span id="annotated-cell-6-10" class="code-annotation-target"><a href="#annotated-cell-6-10" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">group_by</span>(event_player_1_name) <span class="sc">|&gt;</span></span>
<span id="annotated-cell-6-11"><a href="#annotated-cell-6-11" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">summarise</span>(</span>
<span id="annotated-cell-6-12"><a href="#annotated-cell-6-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">player =</span> <span class="fu">unique</span>(event_player_1_name), </span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-6" data-target-annotation="3" onclick="event.preventDefault();" href="">3</a><span id="annotated-cell-6-13" class="code-annotation-target"><a href="#annotated-cell-6-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">GOE =</span> <span class="fu">round</span>(<span class="fu">sum</span>(diff),<span class="dv">3</span>),</span>
<span id="annotated-cell-6-14"><a href="#annotated-cell-6-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">shots =</span> dplyr<span class="sc">::</span><span class="fu">n</span>(),</span>
<span id="annotated-cell-6-15"><a href="#annotated-cell-6-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">goals =</span> <span class="fu">sum</span>(Y)</span>
<span id="annotated-cell-6-16"><a href="#annotated-cell-6-16" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-6" data-target-annotation="4" onclick="event.preventDefault();" href="">4</a><span id="annotated-cell-6-17" class="code-annotation-target"><a href="#annotated-cell-6-17" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(player, shots, goals, GOE) <span class="sc">|&gt;</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-6" data-target-annotation="5" onclick="event.preventDefault();" href="">5</a><span id="annotated-cell-6-18" class="code-annotation-target"><a href="#annotated-cell-6-18" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">arrange</span>(dplyr<span class="sc">::</span><span class="fu">desc</span>(GOE))</span>
<span id="annotated-cell-6-19"><a href="#annotated-cell-6-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-6-20"><a href="#annotated-cell-6-20" aria-hidden="true" tabindex="-1"></a>goe_model_1</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-annotation">
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-6" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-6" data-code-lines="9" data-code-annotation="1">Calculate goal difference from expected</span>
</dd>
<dt data-target-cell="annotated-cell-6" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-6" data-code-lines="10" data-code-annotation="2">Group by player</span>
</dd>
<dt data-target-cell="annotated-cell-6" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-6" data-code-lines="13" data-code-annotation="3">Sum GOE</span>
</dd>
<dt data-target-cell="annotated-cell-6" data-target-annotation="4">4</dt>
<dd>
<span data-code-cell="annotated-cell-6" data-code-lines="17" data-code-annotation="4">Select final columns</span>
</dd>
<dt data-target-cell="annotated-cell-6" data-target-annotation="5">5</dt>
<dd>
<span data-code-cell="annotated-cell-6" data-code-lines="18" data-code-annotation="5">Sort by GOE descending</span>
</dd>
</dl>
</div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 905 × 4
   player                shots goals   GOE
   &lt;chr&gt;                 &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt;
 1 Sam Reinhart            316    71  37.1
 2 Auston Matthews         395    72  30.6
 3 Zach Hyman              380    70  26.9
 4 Artemi Panarin          353    58  23.6
 5 Leon Draisaitl          292    52  21.5
 6 Brock Boeser            231    47  21.4
 7 Steven Stamkos          278    46  20.1
 8 Jonathan Marchessault   294    47  17.9
 9 Kirill Kaprizov         281    46  17.1
10 Valeri Nichushkin       183    38  17.0
# ℹ 895 more rows</code></pre>
</div>
</div>
<p>We can see big scorers like Auston Matthews and Leon Draisatil appear on our list. However, there may be some issues with this model. Since we are only predicting on shot types, a wrist shot from the blue line and a wrist shot a foot away from the net will have the same chance of going in, according to this model.</p>
</section>
<section id="model-2" class="level2">
<h2 class="anchored" data-anchor-id="model-2">Model 2</h2>
<p>Model 2 will add more parameters than Model 1, and it will use logistic regression in order to predict expected goals. The parameters we will use for this model will be shot type, distance from the goal, and shot angle. Shot distance is measured in feet away from the goal. Shot angle is at 0 when a shot is taken directly in front of a goalie and goes to 90 when a shot is taken from the goal line on the right or the left. We will filter our data again by shots and goals and add a numerical goal column like we did in model 1.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>pbp_model_2 <span class="ot">&lt;-</span> pbp_train <span class="sc">|&gt;</span> </span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(xg, season, description, event_type, event, secondary_type,shot_distance, shot_angle, event_player_1_name, event_player_1_id) <span class="sc">|&gt;</span> </span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(event_type <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"SHOT"</span>, <span class="st">"GOAL"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">Y =</span> <span class="fu">ifelse</span>(event_type <span class="sc">==</span> <span class="st">"GOAL"</span>, <span class="dv">1</span>, <span class="dv">0</span>))</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>pbp_model_2</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 234,282 × 11
       xg season   description     event_type event secondary_type shot_distance
    &lt;dbl&gt; &lt;chr&gt;    &lt;chr&gt;           &lt;chr&gt;      &lt;chr&gt; &lt;chr&gt;                  &lt;dbl&gt;
 1 0.0204 20202021 Travis Konecny… SHOT       Shot  Wrist Shot              32.6
 2 0.0208 20202021 Evan Rodrigues… SHOT       Shot  Wrist Shot              47.2
 3 0.0148 20202021 Joel Farabee B… SHOT       Shot  Backhand                48.3
 4 0.0131 20202021 Evan Rodrigues… SHOT       Shot  Snap Shot               60.3
 5 0.171  20202021 Claude Giroux … SHOT       Shot  Slap Shot               36.9
 6 0.281  20202021 Philippe Myers… SHOT       Shot  Wrist Shot              19.2
 7 0.0130 20202021 Sam Lafferty W… SHOT       Shot  Wrist Shot              46.1
 8 0.0208 20202021 Travis Konecny… SHOT       Shot  Wrist Shot              41  
 9 0.285  20202021 Mark Jankowski… GOAL       Goal  Snap Shot                9.4
10 0.0245 20202021 Mike Matheson … SHOT       Shot  Wrist Shot              57  
# ℹ 234,272 more rows
# ℹ 4 more variables: shot_angle &lt;dbl&gt;, event_player_1_name &lt;chr&gt;,
#   event_player_1_id &lt;int&gt;, Y &lt;dbl&gt;</code></pre>
</div>
</div>
<p>We will then build a logistic regression model with our 3 parameters as mentioned before</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>model_2_fit <span class="ot">&lt;-</span> <span class="fu">glm</span>(<span class="at">formula =</span> Y<span class="sc">~</span>shot_distance <span class="sc">+</span> shot_angle <span class="sc">+</span> secondary_type, <span class="at">data =</span> pbp_model_2, <span class="at">family =</span> <span class="fu">binomial</span>(<span class="st">"logit"</span>))</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>model_2_fit</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:  glm(formula = Y ~ shot_distance + shot_angle + secondary_type, 
    family = binomial("logit"), data = pbp_model_2)

Coefficients:
               (Intercept)               shot_distance  
                  -0.97348                    -0.03798  
                shot_angle        secondary_typeBatted  
                  -0.01317                     0.72395  
secondary_typeBetween Legs        secondary_typeCradle  
                   0.03674                     1.24339  
   secondary_typeDeflected  secondary_typePenalty Shot  
                   0.24263                     1.12735  
        secondary_typePoke     secondary_typeSlap Shot  
                   0.02471                     0.48893  
   secondary_typeSnap Shot        secondary_typeTip-In  
                   0.50279                     0.17230  
 secondary_typeWrap-around    secondary_typeWrist Shot  
                  -0.55114                     0.22909  

Degrees of Freedom: 234252 Total (i.e. Null);  234239 Residual
  (29 observations deleted due to missingness)
Null Deviance:      152500 
Residual Deviance: 142800   AIC: 142800</code></pre>
</div>
</div>
<p>Our model predicts that as shot distance and angle increase, the chances of a shot going in will decrease, which makes sense intuitively. We will now use this model to predict the expected goal for all shots and goals of the 2023-2024 season and find the players with the highest goals over expected using this model.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="annotated-cell-9"><pre class="sourceCode r code-annotation-code code-with-copy code-annotated"><code class="sourceCode r"><span id="annotated-cell-9-1"><a href="#annotated-cell-9-1" aria-hidden="true" tabindex="-1"></a>model_2_test <span class="ot">&lt;-</span> pbp_test <span class="sc">|&gt;</span> </span>
<span id="annotated-cell-9-2"><a href="#annotated-cell-9-2" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(event_type <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"SHOT"</span>, <span class="st">"GOAL"</span>)) <span class="sc">|&gt;</span> </span>
<span id="annotated-cell-9-3"><a href="#annotated-cell-9-3" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(description, event_type, event, secondary_type,shot_distance, shot_angle, event_player_1_name, event_player_1_id) <span class="sc">|&gt;</span> </span>
<span id="annotated-cell-9-4"><a href="#annotated-cell-9-4" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">Y =</span> <span class="fu">ifelse</span>(event_type <span class="sc">==</span> <span class="st">"GOAL"</span>, <span class="dv">1</span>, <span class="dv">0</span>)) <span class="sc">|&gt;</span> </span>
<span id="annotated-cell-9-5"><a href="#annotated-cell-9-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(shots_model_1, <span class="at">by =</span> <span class="st">"secondary_type"</span>)</span>
<span id="annotated-cell-9-6"><a href="#annotated-cell-9-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-9-7"><a href="#annotated-cell-9-7" aria-hidden="true" tabindex="-1"></a>model_2_test <span class="ot">&lt;-</span> model_2_test <span class="sc">|&gt;</span> </span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-9" data-target-annotation="1" onclick="event.preventDefault();" href="">1</a><span id="annotated-cell-9-8" class="code-annotation-target"><a href="#annotated-cell-9-8" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">xg2 =</span> <span class="fu">predict</span>(model_2_fit, <span class="at">newdata =</span> model_2_test, <span class="at">type=</span><span class="st">"response"</span>)) <span class="sc">|&gt;</span></span>
<span id="annotated-cell-9-9"><a href="#annotated-cell-9-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">drop_na</span>(xg2) </span>
<span id="annotated-cell-9-10"><a href="#annotated-cell-9-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-9-11"><a href="#annotated-cell-9-11" aria-hidden="true" tabindex="-1"></a>model_2_test <span class="ot">&lt;-</span> model_2_test <span class="sc">|&gt;</span> </span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-9" data-target-annotation="2" onclick="event.preventDefault();" href="">2</a><span id="annotated-cell-9-12" class="code-annotation-target"><a href="#annotated-cell-9-12" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">GOE_ON_PLAY =</span> Y <span class="sc">-</span> xg2)</span>
<span id="annotated-cell-9-13"><a href="#annotated-cell-9-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-9-14"><a href="#annotated-cell-9-14" aria-hidden="true" tabindex="-1"></a>goe_model_2 <span class="ot">&lt;-</span> model_2_test <span class="sc">|&gt;</span> </span>
<span id="annotated-cell-9-15"><a href="#annotated-cell-9-15" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">group_by</span>(event_player_1_name) <span class="sc">|&gt;</span> </span>
<span id="annotated-cell-9-16"><a href="#annotated-cell-9-16" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">summarise</span>(</span>
<span id="annotated-cell-9-17"><a href="#annotated-cell-9-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">GOE =</span> <span class="fu">sum</span>(GOE_ON_PLAY),</span>
<span id="annotated-cell-9-18"><a href="#annotated-cell-9-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">shots =</span> <span class="fu">n</span>(),</span>
<span id="annotated-cell-9-19"><a href="#annotated-cell-9-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">goals =</span> <span class="fu">sum</span>(Y),</span>
<span id="annotated-cell-9-20"><a href="#annotated-cell-9-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="annotated-cell-9-21"><a href="#annotated-cell-9-21" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="annotated-cell-9-22"><a href="#annotated-cell-9-22" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">GOE =</span> <span class="fu">round</span>(GOE, <span class="dv">3</span>)) <span class="sc">|&gt;</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-9" data-target-annotation="3" onclick="event.preventDefault();" href="">3</a><span id="annotated-cell-9-23" class="code-annotation-target"><a href="#annotated-cell-9-23" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="at">player =</span> event_player_1_name, goals, shots, GOE) <span class="sc">|&gt;</span></span>
<span id="annotated-cell-9-24"><a href="#annotated-cell-9-24" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">arrange</span>(<span class="fu">desc</span>(GOE))</span>
<span id="annotated-cell-9-25"><a href="#annotated-cell-9-25" aria-hidden="true" tabindex="-1"></a>goe_model_2</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-annotation">
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-9" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-9" data-code-lines="8" data-code-annotation="1">Predict expected goals for each shot using the model 2 fit; remove rows where prediction fails (NA)</span>
</dd>
<dt data-target-cell="annotated-cell-9" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-9" data-code-lines="12" data-code-annotation="2">Calculate GOE for each shot</span>
</dd>
<dt data-target-cell="annotated-cell-9" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-9" data-code-lines="23" data-code-annotation="3">Renaming column for clarity and select relevant columns</span>
</dd>
</dl>
</div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 905 × 4
   player                goals shots   GOE
   &lt;chr&gt;                 &lt;dbl&gt; &lt;int&gt; &lt;dbl&gt;
 1 Sam Reinhart             71   316  32.5
 2 Auston Matthews          72   395  26.4
 3 Artemi Panarin           58   353  26.1
 4 Leon Draisaitl           52   292  19.7
 5 Jonathan Marchessault    47   294  18.6
 6 Steven Stamkos           46   278  17.9
 7 Brock Boeser             47   231  17.1
 8 Brayden Point            49   245  16.5
 9 Kirill Kaprizov          46   281  16.3
10 Mikko Rantanen           47   307  15.5
# ℹ 895 more rows</code></pre>
</div>
</div>
<p>Our list of leaders still has the big names like our model 1 list did. However, their goals over expected have appeared to decrease a little bit. This could be because they are getting less goals over expected for goals made close and in front of the goalie which are where most goals in hockey are scored from.</p>
</section>
<section id="model-3" class="level2">
<h2 class="anchored" data-anchor-id="model-3">Model 3</h2>
<p>Our third model will add 2 more predictors on top of what we used in model 2. In addition to shot type, shot distance, and shot angle we will also be using goalie save percentage for the goalie the shot was taken on, as well as the strength of the scoring team. Here we will begin filtering our data for this.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>pbp_model_3 <span class="ot">&lt;-</span> pbp_train <span class="sc">|&gt;</span> </span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(xg, season, description, event_type, event, secondary_type, event_goalie_name, event_goalie_id, strength_code, strength, shot_distance, shot_angle, event_player_1_name, event_player_1_id) <span class="sc">|&gt;</span> </span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(event_type <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"SHOT"</span>, <span class="st">"GOAL"</span>))</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>pbp_model_3</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 234,282 × 14
       xg season   description event_type event secondary_type event_goalie_name
    &lt;dbl&gt; &lt;chr&gt;    &lt;chr&gt;       &lt;chr&gt;      &lt;chr&gt; &lt;chr&gt;          &lt;chr&gt;            
 1 0.0204 20202021 Travis Kon… SHOT       Shot  Wrist Shot     Tristan.Jarry    
 2 0.0208 20202021 Evan Rodri… SHOT       Shot  Wrist Shot     Carter.Hart      
 3 0.0148 20202021 Joel Farab… SHOT       Shot  Backhand       Tristan.Jarry    
 4 0.0131 20202021 Evan Rodri… SHOT       Shot  Snap Shot      Carter.Hart      
 5 0.171  20202021 Claude Gir… SHOT       Shot  Slap Shot      Tristan.Jarry    
 6 0.281  20202021 Philippe M… SHOT       Shot  Wrist Shot     Tristan.Jarry    
 7 0.0130 20202021 Sam Laffer… SHOT       Shot  Wrist Shot     Carter.Hart      
 8 0.0208 20202021 Travis Kon… SHOT       Shot  Wrist Shot     Tristan.Jarry    
 9 0.285  20202021 Mark Janko… GOAL       Goal  Snap Shot      Carter.Hart      
10 0.0245 20202021 Mike Mathe… SHOT       Shot  Wrist Shot     Carter.Hart      
# ℹ 234,272 more rows
# ℹ 7 more variables: event_goalie_id &lt;int&gt;, strength_code &lt;chr&gt;,
#   strength &lt;chr&gt;, shot_distance &lt;dbl&gt;, shot_angle &lt;dbl&gt;,
#   event_player_1_name &lt;chr&gt;, event_player_1_id &lt;int&gt;</code></pre>
</div>
</div>
<p>Since hockeyR does not contain data for goalie save percentage, we will have to implement this column for our training and test data. We will find this number by taking the sum of plays a goalie is involved in a shot and divide it by the sum of plays a goalie is involved in a shot and a goal. We will remove NA goalies which represent empty nets since these will skew the sv_pct predictor.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="annotated-cell-11"><pre class="sourceCode r code-annotation-code code-with-copy code-annotated"><code class="sourceCode r"><span id="annotated-cell-11-1"><a href="#annotated-cell-11-1" aria-hidden="true" tabindex="-1"></a>goalies_train <span class="ot">&lt;-</span> pbp_model_3 <span class="sc">|&gt;</span> <span class="fu">group_by</span>(event_goalie_name, season) <span class="sc">|&gt;</span> </span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-11" data-target-annotation="1" onclick="event.preventDefault();" href="">1</a><span id="annotated-cell-11-2" class="code-annotation-target"><a href="#annotated-cell-11-2" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">summarize</span>(<span class="at">sv_pct =</span> <span class="fu">sum</span>(event_type <span class="sc">==</span> <span class="st">"SHOT"</span>) <span class="sc">/</span> <span class="fu">n</span>())</span>
<span id="annotated-cell-11-3"><a href="#annotated-cell-11-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-11-4"><a href="#annotated-cell-11-4" aria-hidden="true" tabindex="-1"></a></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-11" data-target-annotation="2" onclick="event.preventDefault();" href="">2</a><span id="annotated-cell-11-5" class="code-annotation-target"><a href="#annotated-cell-11-5" aria-hidden="true" tabindex="-1"></a>pbp_model_3 <span class="ot">&lt;-</span> <span class="fu">left_join</span>(pbp_model_3, goalies_train, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"event_goalie_name"</span>, <span class="st">"season"</span>))</span>
<span id="annotated-cell-11-6"><a href="#annotated-cell-11-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-11-7"><a href="#annotated-cell-11-7" aria-hidden="true" tabindex="-1"></a>pbp_model_3 <span class="ot">&lt;-</span> pbp_model_3 <span class="sc">|&gt;</span> </span>
<span id="annotated-cell-11-8"><a href="#annotated-cell-11-8" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">Y =</span> <span class="fu">ifelse</span>(event_type <span class="sc">==</span> <span class="st">"GOAL"</span>, <span class="dv">1</span>, <span class="dv">0</span>)) <span class="sc">|&gt;</span> </span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-11" data-target-annotation="3" onclick="event.preventDefault();" href="">3</a><span id="annotated-cell-11-9" class="code-annotation-target"><a href="#annotated-cell-11-9" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">event_goalie_name =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(event_goalie_name), <span class="st">"Empty Net"</span>, event_goalie_name))</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-annotation">
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-11" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-11" data-code-lines="2" data-code-annotation="1">Save % = shots saved / total shots faced</span>
</dd>
<dt data-target-cell="annotated-cell-11" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-11" data-code-lines="5" data-code-annotation="2">Joining goalie save % back to pbp_model_3</span>
</dd>
<dt data-target-cell="annotated-cell-11" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-11" data-code-lines="9" data-code-annotation="3">Fill missing goalie names with “Empty Net”</span>
</dd>
</dl>
</div>
</div>
<p>Once we have this attached to our data set we are able to fit a logistic regression model using shot distance, shot angle, shot type, sv_pct, and team strength</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="annotated-cell-12"><pre class="sourceCode r code-annotation-code code-with-copy code-annotated"><code class="sourceCode r"><a class="code-annotation-anchor" data-target-cell="annotated-cell-12" data-target-annotation="1" onclick="event.preventDefault();" href="">1</a><span id="annotated-cell-12-1" class="code-annotation-target"><a href="#annotated-cell-12-1" aria-hidden="true" tabindex="-1"></a>model_3_fit <span class="ot">&lt;-</span> <span class="fu">glm</span>(<span class="at">formula =</span> Y<span class="sc">~</span>shot_distance <span class="sc">+</span> shot_angle <span class="sc">+</span> secondary_type <span class="sc">+</span> sv_pct <span class="sc">+</span> strength, <span class="at">data =</span> pbp_model_3, <span class="at">family =</span> <span class="fu">binomial</span>(<span class="st">"logit"</span>))</span>
<span id="annotated-cell-12-2"><a href="#annotated-cell-12-2" aria-hidden="true" tabindex="-1"></a>model_3_fit</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-annotation">
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-12" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-12" data-code-lines="1" data-code-annotation="1">Fitting the logistic regression model using shot features + goalie save % + team strength</span>
</dd>
</dl>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:  glm(formula = Y ~ shot_distance + shot_angle + secondary_type + 
    sv_pct + strength, family = binomial("logit"), data = pbp_model_3)

Coefficients:
               (Intercept)               shot_distance  
                  11.11790                    -0.05388  
                shot_angle        secondary_typeBatted  
                  -0.01233                     0.70745  
secondary_typeBetween Legs        secondary_typeCradle  
                  -0.09129                     1.31750  
   secondary_typeDeflected  secondary_typePenalty Shot  
                   0.32361                     1.17451  
        secondary_typePoke     secondary_typeSlap Shot  
                  -0.15978                     0.94691  
   secondary_typeSnap Shot        secondary_typeTip-In  
                   0.75162                     0.21205  
 secondary_typeWrap-around    secondary_typeWrist Shot  
                  -0.59727                     0.36483  
                    sv_pct          strengthPower Play  
                 -13.33082                     0.33313  
       strengthShorthanded  
                   0.19792  

Degrees of Freedom: 233568 Total (i.e. Null);  233552 Residual
  (713 observations deleted due to missingness)
Null Deviance:      151000 
Residual Deviance: 130500   AIC: 130500</code></pre>
</div>
</div>
<p>As you can see our coefficients are similar to our previous model. We also can see the significance of our new predictors for example goalie save percentage has a very strong negative impact on the chances of a shot going in. We also see that a shots chances of going in increase when a team is on a powerplay. Now we can add a save percentage column to our test data and find the goals over expected leaders for this model.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>model_3_test <span class="ot">&lt;-</span> pbp_test <span class="sc">|&gt;</span> </span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(description, event_type, event, secondary_type,</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>                event_goalie_name, event_goalie_id, strength_code, strength,</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>                shot_distance, shot_angle, event_player_1_name, event_player_1_id) <span class="sc">|&gt;</span> </span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(event_type <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"SHOT"</span>, <span class="st">"GOAL"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">Y =</span> <span class="fu">ifelse</span>(event_type <span class="sc">==</span> <span class="st">"GOAL"</span>, <span class="dv">1</span>, <span class="dv">0</span>))</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>goalies_test <span class="ot">&lt;-</span> model_3_test <span class="sc">|&gt;</span> </span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">group_by</span>(event_goalie_name) <span class="sc">|&gt;</span> </span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">summarize</span>(<span class="at">sv_pct =</span> <span class="fu">sum</span>(event_type <span class="sc">==</span> <span class="st">"SHOT"</span>) <span class="sc">/</span> <span class="fu">n</span>())</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>model_3_test <span class="ot">&lt;-</span> <span class="fu">left_join</span>(model_3_test, goalies_test, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"event_goalie_name"</span>))</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>model_3_test <span class="ot">&lt;-</span> model_3_test <span class="sc">|&gt;</span> </span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">Y =</span> <span class="fu">ifelse</span>(event_type <span class="sc">==</span> <span class="st">"GOAL"</span>, <span class="dv">1</span>, <span class="dv">0</span>),</span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>         <span class="at">event_goalie_name =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(event_goalie_name), <span class="st">"Empty Net"</span>, event_goalie_name)) </span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>model_3_test <span class="ot">&lt;-</span> model_3_test <span class="sc">|&gt;</span> </span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">xg3 =</span> <span class="fu">predict</span>(model_3_fit, <span class="at">newdata =</span> model_3_test, <span class="at">type=</span><span class="st">"response"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">drop_na</span>(xg3)</span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a>model_3_test <span class="ot">&lt;-</span> model_3_test <span class="sc">|&gt;</span> </span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">GOE_ON_PLAY =</span> Y <span class="sc">-</span> xg3) </span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a>goe_model_3 <span class="ot">&lt;-</span> model_3_test <span class="sc">|&gt;</span> </span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">group_by</span>(event_player_1_name) <span class="sc">|&gt;</span> </span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">summarise</span>(</span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">GOE =</span> <span class="fu">sum</span>(GOE_ON_PLAY),</span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">shots =</span> <span class="fu">n</span>(),</span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">goals =</span> <span class="fu">sum</span>(Y),</span>
<span id="cb14-33"><a href="#cb14-33" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb14-34"><a href="#cb14-34" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb14-35"><a href="#cb14-35" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">GOE =</span> <span class="fu">round</span>(GOE, <span class="dv">3</span>)) <span class="sc">|&gt;</span></span>
<span id="cb14-36"><a href="#cb14-36" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="at">player =</span> event_player_1_name, goals, shots, GOE) <span class="sc">|&gt;</span> </span>
<span id="cb14-37"><a href="#cb14-37" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">arrange</span>(<span class="fu">desc</span>(GOE))</span>
<span id="cb14-38"><a href="#cb14-38" aria-hidden="true" tabindex="-1"></a>goe_model_3</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 905 × 4
   player           goals shots   GOE
   &lt;chr&gt;            &lt;dbl&gt; &lt;int&gt; &lt;dbl&gt;
 1 Auston Matthews     71   394  24.3
 2 Sam Reinhart        68   313  21.7
 3 Artemi Panarin      54   348  19.9
 4 Leon Draisaitl      51   291  16.8
 5 Kirill Kaprizov     46   280  13.6
 6 Mikko Rantanen      46   305  13.2
 7 Steven Stamkos      45   277  13.0
 8 Nathan MacKinnon    55   454  12.9
 9 Filip Forsberg      50   364  12.6
10 J.T. Miller         40   225  12.3
# ℹ 895 more rows</code></pre>
</div>
</div>
<p>Here we see a similar list of players as before with Auston Matthews taking the top spot. We also see that in our top goal scores, GOE has gone down a bit.</p>
</section>
<section id="model-comparison" class="level2">
<h2 class="anchored" data-anchor-id="model-comparison">Model Comparison</h2>
<p>To compare the performance of our models against each other we will find the log loss that is generated on the same test data for each model. This is a way to attribute a score to how far our predictions are compared to the actual results. We will also be testing our results against hockeyR’s own xg model</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="annotated-cell-14"><pre class="sourceCode r code-annotation-code code-with-copy code-annotated"><code class="sourceCode r"><span id="annotated-cell-14-1"><a href="#annotated-cell-14-1" aria-hidden="true" tabindex="-1"></a>logloss <span class="ot">&lt;-</span> <span class="cf">function</span>(y, phat){</span>
<span id="annotated-cell-14-2"><a href="#annotated-cell-14-2" aria-hidden="true" tabindex="-1"></a>  keep <span class="ot">&lt;-</span> <span class="sc">!</span><span class="fu">is.na</span>(y) <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(phat)</span>
<span id="annotated-cell-14-3"><a href="#annotated-cell-14-3" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> y[keep]</span>
<span id="annotated-cell-14-4"><a href="#annotated-cell-14-4" aria-hidden="true" tabindex="-1"></a>  phat <span class="ot">&lt;-</span> phat[keep]</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-14" data-target-annotation="1" onclick="event.preventDefault();" href="">1</a><span id="annotated-cell-14-5" class="code-annotation-target"><a href="#annotated-cell-14-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">any</span>(phat <span class="sc">&lt;</span> <span class="fl">1e-12</span>)) phat[phat <span class="sc">&lt;</span> <span class="fl">1e-12</span>] <span class="ot">&lt;-</span> <span class="fl">1e-12</span></span>
<span id="annotated-cell-14-6"><a href="#annotated-cell-14-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">any</span>(phat <span class="sc">&gt;</span> <span class="dv">1</span> <span class="sc">-</span> <span class="fl">1e-12</span>)) phat[phat <span class="sc">&gt;</span> <span class="dv">1</span> <span class="sc">-</span> <span class="fl">1e-12</span>] <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> <span class="fl">1e-12</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-14" data-target-annotation="2" onclick="event.preventDefault();" href="">2</a><span id="annotated-cell-14-7" class="code-annotation-target"><a href="#annotated-cell-14-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="sc">-</span><span class="dv">1</span> <span class="sc">*</span> <span class="fu">mean</span>(y <span class="sc">*</span> <span class="fu">log</span>(phat) <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">-</span> y) <span class="sc">*</span> <span class="fu">log</span>(<span class="dv">1</span> <span class="sc">-</span> phat)))</span>
<span id="annotated-cell-14-8"><a href="#annotated-cell-14-8" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="annotated-cell-14-9"><a href="#annotated-cell-14-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-14-10"><a href="#annotated-cell-14-10" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Model 1 Log Loss:"</span>,</span>
<span id="annotated-cell-14-11"><a href="#annotated-cell-14-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">round</span>(<span class="fu">logloss</span>(model_1_test<span class="sc">$</span>Y, model_1_test<span class="sc">$</span>shooting_pct), <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="annotated-cell-14-12"><a href="#annotated-cell-14-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-14-13"><a href="#annotated-cell-14-13" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Model 2 Log Loss:"</span>,</span>
<span id="annotated-cell-14-14"><a href="#annotated-cell-14-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">round</span>(<span class="fu">logloss</span>(model_2_test<span class="sc">$</span>Y, model_2_test<span class="sc">$</span>xg2), <span class="at">digits=</span><span class="dv">3</span>),<span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="annotated-cell-14-15"><a href="#annotated-cell-14-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-14-16"><a href="#annotated-cell-14-16" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Model 3 Log Loss:"</span>,</span>
<span id="annotated-cell-14-17"><a href="#annotated-cell-14-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">round</span>(<span class="fu">logloss</span>(model_3_test<span class="sc">$</span>Y, model_3_test<span class="sc">$</span>xg3), <span class="at">digits=</span><span class="dv">3</span>),<span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="annotated-cell-14-18"><a href="#annotated-cell-14-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-14-19"><a href="#annotated-cell-14-19" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"NHL xG Log Loss:"</span>,</span>
<span id="annotated-cell-14-20"><a href="#annotated-cell-14-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">round</span>(<span class="fu">logloss</span>(pbp_model_1<span class="sc">$</span>Y, pbp_model_1<span class="sc">$</span>xg), <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-annotation">
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-14" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-14" data-code-lines="5" data-code-annotation="1">Avoid log(0)</span>
</dd>
<dt data-target-cell="annotated-cell-14" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-14" data-code-lines="7" data-code-annotation="2">Log loss formula</span>
</dd>
</dl>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Model 1 Log Loss: 0.329 
Model 2 Log Loss: 0.309 
Model 3 Log Loss: 0.269 
NHL xG Log Loss: 0.269 </code></pre>
</div>
</div>
<p>As you can see our first model didn’t do a great job in this test. This is likely because we used a single predictor that left out a lot of important factors about a shot. Our second model seemed to perform a bit better with the addition of distance and shot angle into our model. After adding 2 more important parameters goalie save percentage and team strength it appears that our model performed just as well on the 2023-2024 data as hockeyR’s xg did on the 2020-2023 data.</p>
</section>
<section id="findings" class="level2">
<h2 class="anchored" data-anchor-id="findings">Findings</h2>
<p>Let’s take one more look at our GOE leaders for the 2023-2024 season, and take a deeper dive into Auston Matthews.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="annotated-cell-15"><pre class="sourceCode r code-annotation-code code-with-copy code-annotated"><code class="sourceCode r"><span id="annotated-cell-15-1"><a href="#annotated-cell-15-1" aria-hidden="true" tabindex="-1"></a>pbp_matthews_goals <span class="ot">&lt;-</span> model_3_test <span class="sc">|&gt;</span> </span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-15" data-target-annotation="1" onclick="event.preventDefault();" href="">1</a><span id="annotated-cell-15-2" class="code-annotation-target"><a href="#annotated-cell-15-2" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(event_player_1_name <span class="sc">==</span> <span class="st">"Auston Matthews"</span>) <span class="sc">|&gt;</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-15" data-target-annotation="2" onclick="event.preventDefault();" href="">2</a><span id="annotated-cell-15-3" class="code-annotation-target"><a href="#annotated-cell-15-3" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(Y <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">|&gt;</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-15" data-target-annotation="3" onclick="event.preventDefault();" href="">3</a><span id="annotated-cell-15-4" class="code-annotation-target"><a href="#annotated-cell-15-4" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">arrange</span>(<span class="fu">desc</span>(xg3))</span>
<span id="annotated-cell-15-5"><a href="#annotated-cell-15-5" aria-hidden="true" tabindex="-1"></a>pbp_matthews_goals</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-annotation">
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-15" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-15" data-code-lines="2" data-code-annotation="1">Keeping only Matthews’ shots</span>
</dd>
<dt data-target-cell="annotated-cell-15" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-15" data-code-lines="3" data-code-annotation="2">Only Keeping goals</span>
</dd>
<dt data-target-cell="annotated-cell-15" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-15" data-code-lines="4" data-code-annotation="3">Sort by descending expected goals</span>
</dd>
</dl>
</div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 71 × 16
   description event_type event secondary_type event_goalie_name event_goalie_id
   &lt;glue&gt;      &lt;chr&gt;      &lt;chr&gt; &lt;chr&gt;          &lt;chr&gt;                       &lt;int&gt;
 1 Auston Mat… GOAL       goal  Backhand       Empty Net                      NA
 2 Auston Mat… GOAL       goal  Wrist Shot     Empty Net                      NA
 3 Auston Mat… GOAL       goal  Wrist Shot     Empty Net                      NA
 4 Auston Mat… GOAL       goal  Wrist Shot     Empty Net                      NA
 5 Auston Mat… GOAL       goal  Snap Shot      Ilya Sorokin              8478009
 6 Auston Mat… GOAL       goal  Deflected      Jake Allen                8474596
 7 Auston Mat… GOAL       goal  Snap Shot      Linus Ullmark             8476999
 8 Auston Mat… GOAL       goal  Wrist Shot     Marc-Andre Fleury         8470594
 9 Auston Mat… GOAL       goal  Backhand       Kevin Lankinen            8480947
10 Auston Mat… GOAL       goal  Snap Shot      Lukas Dostal              8480843
# ℹ 61 more rows
# ℹ 10 more variables: strength_code &lt;chr&gt;, strength &lt;chr&gt;,
#   shot_distance &lt;dbl&gt;, shot_angle &lt;dbl&gt;, event_player_1_name &lt;chr&gt;,
#   event_player_1_id &lt;int&gt;, Y &lt;dbl&gt;, sv_pct &lt;dbl&gt;, xg3 &lt;dbl&gt;,
#   GOE_ON_PLAY &lt;dbl&gt;</code></pre>
</div>
</div>
<p>As you can see, the 4 empty net goals he scored had a very high xg and we can see a steep dropoff on goals he scored when a goalie was in net. We can also see that his two longest goals of the year were made on empty nets yet the xg for these shots was very high. This shows our model does a good job recognizing when that shots taken with no goalie have a high chance to go in. We can also take a look at all of his shots and find which shots he generates more goals over expected with.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>pbp_matthews_shots <span class="ot">&lt;-</span> model_3_test <span class="sc">|&gt;</span> </span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(event_player_1_name <span class="sc">==</span> <span class="st">"Auston Matthews"</span>,</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>                event_goalie_name <span class="sc">!=</span> <span class="st">"Empty Net"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">group_by</span>(secondary_type) <span class="sc">|&gt;</span> </span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">summarise</span>(<span class="at">GOE =</span> <span class="fu">sum</span>(GOE_ON_PLAY),</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>                   <span class="at">shots =</span> <span class="fu">n</span>()) <span class="sc">|&gt;</span> </span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">arrange</span>(<span class="fu">desc</span>(GOE))</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>pbp_matthews_shots</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10 × 3
   secondary_type    GOE shots
   &lt;chr&gt;           &lt;dbl&gt; &lt;int&gt;
 1 Wrist Shot     15.3     210
 2 Slap Shot       6.41     33
 3 Backhand        2.46     33
 4 Snap Shot       1.97     56
 5 Deflected       1.30      4
 6 Wrap-around     0.483     9
 7 Poke           -0.118     1
 8 Between Legs   -0.348     3
 9 Batted         -1.13      4
10 Tip-In         -2.08     37</code></pre>
</div>
</div>
<p>Here we can see that his signature go to shot is what generated him the most amount of GOE. Matthews is known for his toe-drag wrist shot that he can place any where he wants. Another interesting piece about this is how his slap shot generated his second most GOE. This might be attributed to the fact that Matthews generally sits on the wing during his teams power plays to take slap shots. Lets take a look at his slap shot goals</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>matthews_slap_shot <span class="ot">&lt;-</span> pbp_matthews_goals <span class="sc">|&gt;</span> </span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(secondary_type <span class="sc">==</span> <span class="st">"Slap Shot"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(strength, shot_distance, shot_angle, xg3, GOE_ON_PLAY)</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>matthews_slap_shot</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10 × 5
   strength   shot_distance shot_angle    xg3 GOE_ON_PLAY
   &lt;chr&gt;              &lt;dbl&gt;      &lt;dbl&gt;  &lt;dbl&gt;       &lt;dbl&gt;
 1 Power Play          26.9       42   0.182        0.818
 2 Power Play          21.3       41.2 0.178        0.822
 3 Power Play          27.7       12.5 0.176        0.824
 4 Power Play          24         73.1 0.140        0.860
 5 Power Play          30.6       51.6 0.140        0.860
 6 Power Play          28.3       45   0.135        0.865
 7 Power Play          44          1.3 0.112        0.888
 8 Power Play          41.6       35.2 0.105        0.895
 9 Even                26.4       52.7 0.101        0.899
10 Power Play          44.6       19.7 0.0895       0.911</code></pre>
</div>
</div>
<p>As we can see, 9/10 of Matthews slap shot goals were on the teams power play. This shows how valuable of an asset he is during man-up situations.</p>
</section>
<section id="improvements" class="level2">
<h2 class="anchored" data-anchor-id="improvements">Improvements</h2>
<p>Our model ended up attaining a log loss that was very similar to hockeyR’s which is very exciting, however it still comes with downsides. One major downside was hockeyR adding shot types to the 2022-2023 season and beyond. As we can see here</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>types_21 <span class="ot">&lt;-</span> pbp21 <span class="sc">|&gt;</span> </span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(event_type <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"SHOT"</span>, <span class="st">"GOAL"</span>))</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"2021-2022 Shot types: "</span>,</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">unique</span>(types_21<span class="sc">$</span>secondary_type), <span class="st">"</span><span class="sc">\n\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>2021-2022 Shot types:  Wrist Shot Slap Shot Backhand Tip-In Snap Shot Wrap-around Deflected Penalty Shot NA </code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"2022-2023 shot types: "</span>,</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">unique</span>(model_1_test<span class="sc">$</span>secondary_type))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>2022-2023 shot types:  Backhand Wrist Shot Snap Shot Tip-In Slap Shot Poke Deflected Wrap-around Batted Between Legs NA Cradle</code></pre>
</div>
</div>
<p>As we can see shots like Between Legs, Batted, and Poke were all added. This means when we trained our data on the 3 season before 2023-2024 ony 1 of them contained all of the relevant shots that 2023-2024 contained. In future development when more seasons are published with the same shot types we will be able to have uniform testing data. Another limitation that could have been a powerful feature would be a column containing defender information. If we had this information we could fine tune our model even more. Currently our model has no idea if there are 0 or 4 defenders between a shooter and the goal. This would be an important parameter because those extra defenders make scoring much more difficult.</p>
</section>
<section id="next-steps" class="level2">
<h2 class="anchored" data-anchor-id="next-steps">Next Steps</h2>
<p>Future development would involve more testing on our final model. We could find the best shooters from certain spots on the ice by isolating distance and angle variables. We would also be able to make heat maps with this data by using sportsR to visualize the xg a shot has when taken from a certain point on the ice. This could be a powerful tool for coaches and players to not only know where to shoot to have the best chance of scoring, but they can also prioritize defending these hot zones. Our model could also be used to build profiles for specific players. Our report took a look at Auston Matthews and found how he was very efficent with slap shots on the power play. Opposing teams can use this information to combat offensive strengths of the best scorers in the league.</p>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>